# Docker é…ç½®æ–‡ä»¶æ€»è§ˆ

æœ¬æ–‡æ¡£æ€»ç»“äº†ä¸ºåŸŸåé…ç½®æœåŠ¡åˆ›å»ºçš„æ‰€æœ‰ Docker ç›¸å…³æ–‡ä»¶ã€‚

## ğŸ“ æ–‡ä»¶åˆ—è¡¨

### æ ¸å¿ƒé…ç½®æ–‡ä»¶

#### 1. docker-compose.yml
**ä½ç½®**: é¡¹ç›®æ ¹ç›®å½•  
**ç”¨é€”**: Docker Compose ä¸»é…ç½®æ–‡ä»¶

**åŒ…å«æœåŠ¡**:
- âœ… åº”ç”¨æœåŠ¡ (app)
- âœ… MySQL 8.0 æ•°æ®åº“
- âœ… Redis 7 ç¼“å­˜ï¼ˆä½¿ç”¨ profileï¼Œé»˜è®¤ä¸å¯åŠ¨ï¼‰

**ç‰¹æ€§**:
- å¤šæœåŠ¡ç¼–æ’
- å¥åº·æ£€æŸ¥é…ç½®
- æ•°æ®å·æŒä¹…åŒ–
- è‡ªå®šä¹‰ç½‘ç»œ
- ç¯å¢ƒå˜é‡é…ç½®

#### 2. docker-compose.redis.yml
**ä½ç½®**: é¡¹ç›®æ ¹ç›®å½•  
**ç”¨é€”**: Redis æœåŠ¡è¦†ç›–é…ç½®

**åŠŸèƒ½**:
- å¯ç”¨ Redis æœåŠ¡
- ç§»é™¤ profile é™åˆ¶
- æ·»åŠ åº”ç”¨å¯¹ Redis çš„ä¾èµ–

**ä½¿ç”¨æ–¹æ³•**:
```bash
docker-compose -f docker-compose.yml -f docker-compose.redis.yml up -d
```

#### 3. Dockerfile
**ä½ç½®**: é¡¹ç›®æ ¹ç›®å½•  
**ç”¨é€”**: åº”ç”¨é•œåƒæ„å»ºé…ç½®

**ç‰¹æ€§**:
- å¤šé˜¶æ®µæ„å»ºï¼ˆbuilder + productionï¼‰
- åŸºäº Node.js 18 Alpine
- é root ç”¨æˆ·è¿è¡Œ
- å¥åº·æ£€æŸ¥
- dumb-init ä¿¡å·å¤„ç†

#### 4. .dockerignore
**ä½ç½®**: é¡¹ç›®æ ¹ç›®å½•  
**ç”¨é€”**: Docker æ„å»ºå¿½ç•¥æ–‡ä»¶

**å¿½ç•¥å†…å®¹**:
- node_modules
- æµ‹è¯•æ–‡ä»¶
- æ–‡æ¡£
- IDE é…ç½®
- Git æ–‡ä»¶
- æ—¥å¿—æ–‡ä»¶

### è¾…åŠ©å·¥å…·

#### 5. Makefile
**ä½ç½®**: é¡¹ç›®æ ¹ç›®å½•  
**ç”¨é€”**: ç®€åŒ– Docker æ“ä½œçš„å‘½ä»¤é›†åˆ

**ä¸»è¦å‘½ä»¤**:
```bash
make help          # æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
make build         # æ„å»ºé•œåƒ
make up            # å¯åŠ¨æœåŠ¡ï¼ˆä¸å« Redisï¼‰
make up-redis      # å¯åŠ¨æœåŠ¡ï¼ˆå« Redisï¼‰
make down          # åœæ­¢æœåŠ¡
make logs          # æŸ¥çœ‹æ—¥å¿—
make ps            # æŸ¥çœ‹çŠ¶æ€
make clean         # æ¸…ç†æ•°æ®
make backup-mysql  # å¤‡ä»½æ•°æ®åº“
make migrate       # è¿è¡Œè¿ç§»
```

#### 6. scripts/docker-quickstart.sh
**ä½ç½®**: scripts/  
**ç”¨é€”**: äº¤äº’å¼å¿«é€Ÿå¯åŠ¨è„šæœ¬

**åŠŸèƒ½**:
- æ£€æŸ¥ Docker ç¯å¢ƒ
- æ£€æŸ¥é…ç½®æ–‡ä»¶
- é€‰æ‹©éƒ¨ç½²æ¨¡å¼
- è‡ªåŠ¨å¯åŠ¨æœåŠ¡
- æ˜¾ç¤ºè®¿é—®ä¿¡æ¯

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/docker-quickstart.sh
```

### æ–‡æ¡£æ–‡ä»¶

#### 7. docs/DOCKER_DEPLOYMENT.md
**ä½ç½®**: docs/  
**ç”¨é€”**: å®Œæ•´çš„ Docker éƒ¨ç½²æŒ‡å—

**å†…å®¹**:
- å¿«é€Ÿå¼€å§‹
- é…ç½®è¯´æ˜
- æœåŠ¡æ¶æ„
- æ•°æ®æŒä¹…åŒ–
- å¥åº·æ£€æŸ¥
- æ•…éšœæ’æŸ¥
- æ€§èƒ½ä¼˜åŒ–
- å®‰å…¨å»ºè®®
- å¸¸ç”¨å‘½ä»¤

#### 8. docker-compose.README.md
**ä½ç½®**: é¡¹ç›®æ ¹ç›®å½•  
**ç”¨é€”**: Docker Compose é…ç½®è¯¦ç»†è¯´æ˜

**å†…å®¹**:
- æ–‡ä»¶è¯´æ˜
- ä½¿ç”¨æ–¹æ³•
- æœåŠ¡é…ç½®è¯¦è§£
- ç¯å¢ƒå˜é‡é…ç½®
- ç½‘ç»œé…ç½®
- æ•°æ®æŒä¹…åŒ–
- å¥åº·æ£€æŸ¥
- æ—¥å¿—ç®¡ç†
- æ•…éšœæ’æŸ¥
- æ€§èƒ½ä¼˜åŒ–

#### 9. docs/DOCKER_FILES_SUMMARY.md
**ä½ç½®**: docs/  
**ç”¨é€”**: æœ¬æ–‡æ¡£ï¼ŒDocker æ–‡ä»¶æ€»è§ˆ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ 1: ä½¿ç”¨ Makeï¼ˆæ¨èï¼‰

```bash
# æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
make help

# å¯åŠ¨æœåŠ¡ï¼ˆå« Redisï¼‰
make up-redis

# æŸ¥çœ‹æ—¥å¿—
make logs

# æŸ¥çœ‹çŠ¶æ€
make ps
```

### æ–¹å¼ 2: ä½¿ç”¨å¿«é€Ÿå¯åŠ¨è„šæœ¬

```bash
./scripts/docker-quickstart.sh
```

### æ–¹å¼ 3: ä½¿ç”¨ Docker Compose

```bash
# å¯åŠ¨æœåŠ¡ï¼ˆä¸å« Redisï¼‰
docker-compose up -d

# å¯åŠ¨æœåŠ¡ï¼ˆå« Redisï¼‰
docker-compose -f docker-compose.yml -f docker-compose.redis.yml up -d
```

## ğŸ“Š æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Docker Host                    â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  domain-config-service (App)               â”‚ â”‚
â”‚  â”‚  - Port: 3000                              â”‚ â”‚
â”‚  â”‚  - Health: /health                         â”‚ â”‚
â”‚  â”‚  - Metrics: /metrics                       â”‚ â”‚
â”‚  â”‚  - API Docs: /api-docs                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                    â”‚                 â”‚
â”‚           â–¼                    â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  MySQL 8.0       â”‚  â”‚  Redis 7         â”‚    â”‚
â”‚  â”‚  - Port: 3306    â”‚  â”‚  - Port: 6379    â”‚    â”‚
â”‚  â”‚  - Volume: data  â”‚  â”‚  - Volume: data  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                  â”‚
â”‚  Network: domain-config-network                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ é…ç½®é€‰é¡¹

### éƒ¨ç½²æ¨¡å¼

| æ¨¡å¼ | å‘½ä»¤ | åŒ…å«æœåŠ¡ |
|------|------|----------|
| æ ‡å‡†æ¨¡å¼ | `make up` | App + MySQL |
| å®Œæ•´æ¨¡å¼ | `make up-redis` | App + MySQL + Redis |
| å¼€å‘æ¨¡å¼ | `make dev` | App + MySQL + Redis (å‰å°è¿è¡Œ) |

### ç¯å¢ƒå˜é‡

ä¸»è¦é…ç½®é¡¹ï¼ˆåœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®ï¼‰ï¼š

```env
# æœåŠ¡é…ç½®
NODE_ENV=production
PORT=3000

# æ•°æ®åº“é…ç½®
DB_NAME=domain_config
DB_PASSWORD=your_secure_password

# Redis é…ç½®
REDIS_ENABLED=true
REDIS_PASSWORD=your_redis_password

# ç®¡ç†é…ç½®
ADMIN_PASSWORD=your_admin_password
```

## ğŸ“¦ æ•°æ®æŒä¹…åŒ–

### æ•°æ®å·

| å·å | ç”¨é€” | ä½ç½® |
|------|------|------|
| mysql-data | MySQL æ•°æ®åº“æ–‡ä»¶ | /var/lib/mysql |
| redis-data | Redis æŒä¹…åŒ–æ•°æ® | /data |
| app-logs | åº”ç”¨æ—¥å¿—æ–‡ä»¶ | /app/logs |

### å¤‡ä»½å‘½ä»¤

```bash
# å¤‡ä»½ MySQL
make backup-mysql

# å¤‡ä»½ Redis
docker-compose exec redis redis-cli SAVE
docker cp domain-config-redis:/data/dump.rdb ./redis-backup.rdb
```

## ğŸ” å¥åº·æ£€æŸ¥

### åº”ç”¨å¥åº·æ£€æŸ¥

```bash
curl http://localhost:3000/health
```

### å®¹å™¨å¥åº·çŠ¶æ€

```bash
docker-compose ps
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æ‰€æœ‰æœåŠ¡
make logs

# ç‰¹å®šæœåŠ¡
make logs-app
make logs-mysql
make logs-redis
```

## ğŸ› ï¸ å¸¸ç”¨æ“ä½œ

### å¯åŠ¨å’Œåœæ­¢

```bash
make up          # å¯åŠ¨ï¼ˆä¸å« Redisï¼‰
make up-redis    # å¯åŠ¨ï¼ˆå« Redisï¼‰
make down        # åœæ­¢
make restart     # é‡å¯
```

### æŸ¥çœ‹çŠ¶æ€

```bash
make ps          # æœåŠ¡çŠ¶æ€
make logs        # æŸ¥çœ‹æ—¥å¿—
```

### ç»´æŠ¤æ“ä½œ

```bash
make migrate         # è¿è¡Œè¿ç§»
make backup-mysql    # å¤‡ä»½æ•°æ®åº“
make clean           # æ¸…ç†æ‰€æœ‰æ•°æ®
```

### è°ƒè¯•æ“ä½œ

```bash
make shell-app       # è¿›å…¥åº”ç”¨å®¹å™¨
make shell-mysql     # è¿›å…¥ MySQL å®¹å™¨
make shell-redis     # è¿›å…¥ Redis å®¹å™¨
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Docker éƒ¨ç½²æŒ‡å—](DOCKER_DEPLOYMENT.md) - å®Œæ•´çš„éƒ¨ç½²æ–‡æ¡£
- [Docker Compose é…ç½®è¯´æ˜](../docker-compose.README.md) - é…ç½®è¯¦è§£
- [é¡¹ç›® README](../README.md) - é¡¹ç›®æ€»è§ˆ
- [ç®¡ç†ç•Œé¢æŒ‡å—](ADMIN_UI_GUIDE.md) - ç®¡ç†ç•Œé¢ä½¿ç”¨
- [æ•°æ®åº“è¿ç§»æŒ‡å—](DATABASE_MIGRATION_QUICKSTART.md) - æ•°æ®åº“è¿ç§»

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **
   - ä¿®æ”¹ `DB_PASSWORD`
   - ä¿®æ”¹ `ADMIN_PASSWORD`
   - è®¾ç½® `REDIS_PASSWORD`

2. **é™åˆ¶ç«¯å£æš´éœ²**
   - ç”Ÿäº§ç¯å¢ƒä¸æš´éœ²æ•°æ®åº“ç«¯å£
   - ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®

3. **å®šæœŸå¤‡ä»½**
   - æ¯æ—¥å¤‡ä»½ MySQL æ•°æ®åº“
   - æµ‹è¯•æ¢å¤æµç¨‹

4. **ç›‘æ§æ—¥å¿—**
   - å®šæœŸæ£€æŸ¥åº”ç”¨æ—¥å¿—
   - é…ç½®æ—¥å¿—è½®è½¬

## ğŸ¯ æœ€ä½³å®è·µ

1. **å¼€å‘ç¯å¢ƒ**
   ```bash
   # ä½¿ç”¨å¼€å‘æ¨¡å¼
   make dev
   ```

2. **ç”Ÿäº§ç¯å¢ƒ**
   ```bash
   # ä½¿ç”¨å®Œæ•´æ¨¡å¼
   make up-redis
   
   # é…ç½®èµ„æºé™åˆ¶
   # é…ç½®æ—¥å¿—è½®è½¬
   # å¯ç”¨ç›‘æ§
   ```

3. **æµ‹è¯•ç¯å¢ƒ**
   ```bash
   # ä½¿ç”¨æ ‡å‡†æ¨¡å¼
   make up
   
   # è¿è¡Œæµ‹è¯•
   make test
   ```

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ [Docker éƒ¨ç½²æŒ‡å—](DOCKER_DEPLOYMENT.md)
2. æŸ¥çœ‹ [æ•…éšœæ’æŸ¥](DOCKER_DEPLOYMENT.md#æ•…éšœæ’æŸ¥)
3. è¿è¡Œ `make help` æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
4. æŸ¥çœ‹æ—¥å¿— `make logs`

---

**åˆ›å»ºæ—¥æœŸ**: 2024-01-24  
**æœ€åæ›´æ–°**: 2024-01-24  
**ç»´æŠ¤è€…**: Domain Config Team
