# Redis 容量规划指南

## 📊 容量评估

### 当前缓存使用情况

根据代码分析，应用使用 Redis 缓存以下数据：

1. **域名配置缓存**
   - 键格式：`domain:config:{domain}`
   - 数据内容：域名配置 JSON 对象
   - TTL：默认 3600 秒（1 小时）

### 单条缓存数据大小估算

**典型域名配置对象：**
```json
{
  "id": 1,
  "domain": "example.com",
  "config": {
    "title": "示例网站",
    "description": "这是一个示例网站的配置",
    "logo": "https://example.com/logo.png",
    "theme": "default",
    "features": ["feature1", "feature2"],
    "settings": {
      "key1": "value1",
      "key2": "value2"
    }
  },
  "permissions": ["read", "write"],
  "homepage": "https://example.com",
  "createdAt": "2026-01-25T00:00:00.000Z",
  "updatedAt": "2026-01-25T00:00:00.000Z"
}
```

**大小估算：**
- 最小配置（简单域名）：~500 字节
- 典型配置（中等复杂度）：~2 KB
- 大型配置（复杂 JSON）：~10 KB
- 极端情况（超大配置）：~50 KB

**Redis 存储开销：**
- 键名：`domain:config:example.com` ≈ 30 字节
- 值：JSON 字符串 ≈ 2 KB（典型）
- Redis 元数据：≈ 100 字节
- **单条缓存总计：≈ 2.1 KB**

---

## 💾 256MB 容量分析

### 理论容量

**假设平均每条缓存 2 KB：**
```
256 MB = 262,144 KB
262,144 KB ÷ 2 KB = 131,072 条缓存
```

**考虑 Redis 实际开销（约 30%）：**
```
131,072 × 0.7 = 91,750 条缓存
```

### 实际使用场景

#### 场景 1: 小型应用（< 1000 个域名）

**域名数量：** 1,000
**缓存数据：** 1,000 × 2 KB = 2 MB
**实际使用：** ~3 MB（含 Redis 开销）

**结论：** ✅ **256MB 绰绰有余**（仅使用 1.2%）

---

#### 场景 2: 中型应用（1,000 - 10,000 个域名）

**域名数量：** 10,000
**缓存数据：** 10,000 × 2 KB = 20 MB
**实际使用：** ~30 MB（含 Redis 开销）

**结论：** ✅ **256MB 完全够用**（使用 11.7%）

---

#### 场景 3: 大型应用（10,000 - 50,000 个域名）

**域名数量：** 50,000
**缓存数据：** 50,000 × 2 KB = 100 MB
**实际使用：** ~150 MB（含 Redis 开销）

**结论：** ✅ **256MB 够用**（使用 58.6%）

---

#### 场景 4: 超大型应用（> 50,000 个域名）

**域名数量：** 100,000
**缓存数据：** 100,000 × 2 KB = 200 MB
**实际使用：** ~300 MB（含 Redis 开销）

**结论：** ⚠️ **需要升级到 512MB 或 1GB**

---

## 🎯 推荐配置

### 根据域名数量选择

| 域名数量 | 推荐 Redis 容量 | 使用率 | 成本 |
|---------|----------------|--------|------|
| < 1,000 | **256MB** | ~1% | 最低 |
| 1,000 - 10,000 | **256MB** | ~12% | 最低 |
| 10,000 - 50,000 | **256MB** 或 512MB | ~59% | 低 |
| 50,000 - 100,000 | **512MB** 或 1GB | ~59% | 中 |
| > 100,000 | **1GB** 或 2GB | ~59% | 中高 |

### 根据访问模式选择

#### 低频访问（大部分域名很少访问）

**特点：**
- 热点域名集中
- 缓存命中率高
- 实际缓存数量 < 总域名数量

**推荐：**
- 使用 **256MB**
- 配置 LRU 淘汰策略
- 即使有 10 万域名，实际缓存可能只有 1-2 万热点域名

#### 高频访问（大部分域名经常访问）

**特点：**
- 访问分布均匀
- 需要缓存更多域名
- 实际缓存数量 ≈ 总域名数量

**推荐：**
- 根据域名总数选择容量
- 考虑预留 40% 空间

---

## 🔧 优化建议

### 1. 使用 LRU 淘汰策略

在腾讯云 Redis 控制台配置：
```
maxmemory-policy: allkeys-lru
```

**效果：**
- 自动淘汰最少使用的缓存
- 保留热点数据
- 256MB 可以支持更多域名

### 2. 调整 TTL

**当前默认：** 3600 秒（1 小时）

**优化建议：**

**低频更新的配置：**
```yaml
environment:
  - REDIS_TTL=7200  # 2 小时
```

**高频更新的配置：**
```yaml
environment:
  - REDIS_TTL=1800  # 30 分钟
```

**效果：**
- 更长的 TTL：减少数据库查询，但占用更多内存
- 更短的 TTL：释放内存更快，但增加数据库查询

### 3. 压缩配置数据

如果配置数据很大，可以考虑压缩：

**修改 CacheService：**
```typescript
import zlib from 'zlib';
import { promisify } from 'util';

const gzip = promisify(zlib.gzip);
const gunzip = promisify(zlib.gunzip);

async set<T>(key: string, value: T, ttl?: number): Promise<void> {
  const serialized = JSON.stringify(value);
  const compressed = await gzip(serialized);
  await client.setex(cacheKey, expireTime, compressed.toString('base64'));
}

async get<T>(key: string): Promise<T | null> {
  const data = await client.get(cacheKey);
  const buffer = Buffer.from(data, 'base64');
  const decompressed = await gunzip(buffer);
  return JSON.parse(decompressed.toString()) as T;
}
```

**效果：**
- 压缩率：50-70%
- 256MB 可以存储 2-3 倍的数据
- 代价：增加 CPU 使用

### 4. 监控内存使用

**查看 Redis 内存使用：**
```bash
# 连接 Redis
redis-cli -h r-xxxxx.redis.rds.tencentyun.com -a your_password

# 查看内存信息
INFO memory

# 查看键数量
DBSIZE

# 查看内存使用详情
MEMORY STATS
```

**关键指标：**
- `used_memory_human`: 实际使用内存
- `used_memory_peak_human`: 峰值内存
- `mem_fragmentation_ratio`: 内存碎片率
- `evicted_keys`: 被淘汰的键数量

---

## 📈 容量规划示例

### 示例 1: 初创项目

**预期：**
- 域名数量：100-500
- 日活跃域名：50-100
- 配置大小：平均 2 KB

**推荐配置：**
```yaml
Redis: 256MB（腾讯云最小规格）
TTL: 3600 秒
淘汰策略: allkeys-lru
```

**预期使用：**
- 内存使用：< 1 MB
- 成本：最低
- 性能：优秀

---

### 示例 2: 成长期项目

**预期：**
- 域名数量：5,000-10,000
- 日活跃域名：2,000-3,000
- 配置大小：平均 3 KB

**推荐配置：**
```yaml
Redis: 256MB
TTL: 3600 秒
淘汰策略: allkeys-lru
```

**预期使用：**
- 内存使用：6-9 MB（活跃域名）
- 成本：低
- 性能：优秀

---

### 示例 3: 成熟期项目

**预期：**
- 域名数量：50,000-100,000
- 日活跃域名：10,000-20,000
- 配置大小：平均 3 KB

**推荐配置：**
```yaml
Redis: 512MB 或 1GB
TTL: 3600 秒
淘汰策略: allkeys-lru
```

**预期使用：**
- 内存使用：30-60 MB（活跃域名）
- 成本：中
- 性能：优秀

**为什么不用 256MB？**
- 预留扩展空间
- 避免频繁淘汰
- 应对流量突增

---

## 🚨 何时需要升级

### 升级信号

1. **内存使用率 > 80%**
   ```bash
   # 查看内存使用
   INFO memory | grep used_memory_human
   ```

2. **频繁的键淘汰**
   ```bash
   # 查看淘汰统计
   INFO stats | grep evicted_keys
   ```
   如果 `evicted_keys` 持续增长，说明内存不足

3. **缓存命中率下降**
   ```bash
   # 查看命中率
   INFO stats | grep keyspace
   ```
   命中率 < 80% 可能需要更多内存

4. **性能下降**
   - 响应时间增加
   - 数据库查询增多

### 升级路径

```
256MB → 512MB → 1GB → 2GB → 4GB
```

**腾讯云 Redis 升级：**
1. 进入云数据库 Redis 控制台
2. 选择实例 → 配置调整
3. 选择新规格
4. 确认升级（通常无需停机）

---

## 💡 最佳实践

### 1. 从小开始

**建议：**
- 初期使用 **256MB**
- 监控实际使用情况
- 根据需要升级

**优势：**
- 降低初期成本
- 避免资源浪费
- 灵活调整

### 2. 设置告警

**腾讯云监控告警：**
```
内存使用率 > 80%：发送告警
淘汰键数量 > 1000/小时：发送告警
连接数 > 80%：发送告警
```

### 3. 定期审查

**每月检查：**
- 内存使用趋势
- 缓存命中率
- 淘汰键统计
- 成本效益

### 4. 预留空间

**推荐：**
- 日常使用率保持在 60-70%
- 预留 30-40% 应对突增流量
- 避免频繁淘汰影响性能

---

## 📊 成本对比

### 腾讯云 Redis 价格参考（按需计费）

| 规格 | 月费用（约） | 适用场景 |
|------|------------|---------|
| 256MB | ¥30-50 | < 10,000 域名 |
| 512MB | ¥60-100 | 10,000-50,000 域名 |
| 1GB | ¥120-200 | 50,000-100,000 域名 |
| 2GB | ¥240-400 | > 100,000 域名 |

**注意：** 实际价格以腾讯云官网为准，不同地域价格可能不同。

---

## ✅ 结论

### 256MB 是否够用？

**对于大多数场景：✅ 完全够用**

- ✅ < 10,000 域名：绰绰有余
- ✅ 10,000-50,000 域名：够用（使用 LRU）
- ⚠️ > 50,000 域名：建议升级到 512MB

### 推荐策略

1. **初期：** 使用 256MB，配置 LRU 淘汰
2. **监控：** 关注内存使用率和淘汰统计
3. **优化：** 调整 TTL，优化配置大小
4. **升级：** 使用率 > 80% 时升级到 512MB

### 关键要点

- 256MB 可以缓存 **9 万+** 条典型配置
- 使用 LRU 策略，实际可支持更多域名
- 只有热点数据会被缓存，冷数据自动淘汰
- 成本低，性价比高

**建议：先用 256MB，根据实际情况调整！**

---

**更新时间**: 2026-01-25
