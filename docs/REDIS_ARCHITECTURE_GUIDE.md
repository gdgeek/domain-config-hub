# Redis 架构选择指南

## 📋 架构对比

### 标准架构（单节点）

**特点：**
- 单个 Redis 实例
- 简单易用
- 成本低

**架构图：**
```
应用服务器 → Redis 单节点（主）
              ↓
           持久化存储
```

### 集群架构（分片集群）

**特点：**
- 多个 Redis 节点
- 数据分片存储
- 高可用、高性能

**架构图：**
```
应用服务器 → Redis Cluster
              ├─ 分片1（主+从）
              ├─ 分片2（主+从）
              └─ 分片3（主+从）
```

---

## 🎯 快速决策

### ⭐ 推荐：标准架构（适合你的场景）

**理由：**
1. ✅ 你的应用是**读多写少**的缓存场景
2. ✅ 数据量小（< 10GB）
3. ✅ 不需要超高并发（< 10 万 QPS）
4. ✅ 成本敏感
5. ✅ 运维简单

---

## 📊 详细对比

### 1. 功能对比

| 特性 | 标准架构 | 集群架构 |
|------|---------|---------|
| **容量** | 单节点最大 64GB | 可扩展到 TB 级 |
| **QPS** | 8-10 万 | 百万级 |
| **数据分片** | ❌ 不支持 | ✅ 自动分片 |
| **高可用** | 主从切换 | 自动故障转移 |
| **横向扩展** | ❌ 不支持 | ✅ 支持 |
| **运维复杂度** | ⭐ 简单 | ⭐⭐⭐ 复杂 |
| **成本** | ⭐ 低 | ⭐⭐⭐ 高 |

### 2. 性能对比

#### 标准架构性能

**单节点性能：**
- 读操作：80,000-100,000 QPS
- 写操作：80,000-100,000 QPS
- 延迟：< 1ms

**适用场景：**
- 日均请求 < 1000 万次
- 峰值 QPS < 5 万
- 数据量 < 10GB

#### 集群架构性能

**集群性能（3 分片）：**
- 读操作：240,000-300,000 QPS
- 写操作：240,000-300,000 QPS
- 延迟：1-2ms

**适用场景：**
- 日均请求 > 1 亿次
- 峰值 QPS > 10 万
- 数据量 > 10GB

### 3. 成本对比

#### 腾讯云 Redis 价格参考

**标准架构（主从版）：**

| 规格 | 月费用（约） | 适用场景 |
|------|------------|---------|
| 256MB | ¥30-50 | 小型应用 |
| 512MB | ¥60-100 | 中小型应用 |
| 1GB | ¥120-200 | 中型应用 |
| 2GB | ¥240-400 | 中大型应用 |
| 4GB | ¥480-800 | 大型应用 |

**集群架构（3 分片）：**

| 规格 | 月费用（约） | 适用场景 |
|------|------------|---------|
| 3×256MB | ¥150-250 | 中型应用 |
| 3×512MB | ¥300-500 | 大型应用 |
| 3×1GB | ¥600-1000 | 超大型应用 |

**成本差异：**
- 集群架构成本约为标准架构的 **5-6 倍**
- 需要至少 3 个分片才能发挥集群优势

### 4. 运维复杂度

#### 标准架构运维

**简单操作：**
- ✅ 一键创建实例
- ✅ 自动主从切换
- ✅ 简单的监控和告警
- ✅ 直接连接使用

**日常维护：**
```bash
# 连接 Redis
redis-cli -h r-xxxxx.redis.rds.tencentyun.com -a password

# 查看状态
INFO

# 清空缓存
FLUSHALL
```

#### 集群架构运维

**复杂操作：**
- ⚠️ 需要规划分片数量
- ⚠️ 需要理解数据分片规则
- ⚠️ 需要处理跨分片操作限制
- ⚠️ 扩容需要数据迁移

**日常维护：**
```bash
# 连接集群（需要特殊客户端）
redis-cli -c -h r-xxxxx.redis.rds.tencentyun.com -a password

# 查看集群状态
CLUSTER INFO
CLUSTER NODES

# 需要注意跨分片操作限制
```

---

## 🔍 你的应用场景分析

### 应用特点

**数据特征：**
- 缓存域名配置（键值对）
- 单条数据：2-10 KB
- 总数据量：< 1 GB（假设 10 万域名）
- 数据访问：读多写少（缓存场景）

**访问模式：**
- 按域名查询（单键查询）
- 不需要跨域名的复杂查询
- 符合 80/20 原则（热点数据集中）

**性能需求：**
- 预估 QPS：1,000-10,000（中小型应用）
- 延迟要求：< 10ms
- 可用性：99.9%

### 推荐方案：✅ 标准架构（主从版）

**理由：**

1. **数据量小**
   - 预估 < 1GB，远小于单节点 64GB 限制
   - 标准架构完全满足

2. **访问模式简单**
   - 单键查询为主
   - 不需要分片带来的复杂性

3. **性能足够**
   - 标准架构 8-10 万 QPS
   - 远超你的实际需求（1-10k QPS）

4. **成本优势**
   - 256MB 标准版：¥30-50/月
   - 3×256MB 集群版：¥150-250/月
   - **节省 70-80% 成本**

5. **运维简单**
   - 无需学习集群管理
   - 无需处理分片逻辑
   - 降低运维成本

---

## 📈 何时需要集群架构

### 升级信号

只有在以下情况下才考虑集群架构：

#### 1. 数据量超大

**标准架构限制：**
- 单节点最大 64GB
- 实际建议 < 32GB（预留空间）

**升级条件：**
```
数据量 > 32GB
或
预计 1 年内增长到 32GB
```

**你的情况：**
- 当前：< 1GB
- 预计增长：10 倍 = 10GB
- **结论：不需要**

#### 2. 性能瓶颈

**标准架构性能：**
- 单节点：8-10 万 QPS
- 主从版：读可扩展到 20-30 万 QPS

**升级条件：**
```
峰值 QPS > 10 万
且
读写比例接近 1:1
```

**你的情况：**
- 当前：1-10k QPS
- 预计增长：10 倍 = 10-100k QPS
- 读写比例：90:10（读多写少）
- **结论：标准架构 + 读写分离足够**

#### 3. 高可用要求

**标准架构可用性：**
- 主从自动切换
- 可用性：99.9%
- 故障恢复：< 30 秒

**升级条件：**
```
可用性要求 > 99.95%
且
不能接受任何数据丢失
```

**你的情况：**
- 缓存数据，可以重建
- 99.9% 可用性足够
- **结论：不需要**

---

## 🎯 推荐配置方案

### 方案 1: 标准架构 - 单机版（开发/测试）

**配置：**
```yaml
架构: 标准架构（单机版）
规格: 256MB
版本: Redis 7.0
```

**适用场景：**
- 开发环境
- 测试环境
- 个人项目

**成本：** ¥20-30/月

**优点：**
- 成本最低
- 配置简单

**缺点：**
- 无高可用
- 故障需要手动恢复

---

### 方案 2: 标准架构 - 主从版（⭐ 推荐生产环境）

**配置：**
```yaml
架构: 标准架构（主从版）
规格: 256MB 或 512MB
版本: Redis 7.0
主从: 1 主 1 从
自动切换: 启用
```

**适用场景：**
- 生产环境
- 中小型应用
- 成本敏感项目

**成本：** ¥30-100/月

**优点：**
- ✅ 自动主从切换
- ✅ 高可用（99.9%）
- ✅ 成本低
- ✅ 运维简单

**缺点：**
- 单节点容量限制（64GB）
- 写性能受限于主节点

**推荐理由：**
- 满足你的所有需求
- 性价比最高
- 运维成本低

---

### 方案 3: 标准架构 - 读写分离（高并发场景）

**配置：**
```yaml
架构: 标准架构（主从版）
规格: 512MB 或 1GB
版本: Redis 7.0
主从: 1 主 2-3 从
读写分离: 启用
```

**适用场景：**
- 读多写少（90:10）
- 高并发读取
- QPS > 5 万

**成本：** ¥100-300/月

**优点：**
- ✅ 读性能可扩展
- ✅ 成本适中
- ✅ 高可用

**缺点：**
- 需要应用层支持读写分离
- 可能有主从延迟

**何时使用：**
- 标准主从版 QPS 不够
- 但数据量 < 10GB
- 读写比例 > 5:1

---

### 方案 4: 集群架构（不推荐你的场景）

**配置：**
```yaml
架构: 集群架构
分片数: 3
每分片规格: 256MB
版本: Redis 7.0
```

**适用场景：**
- 数据量 > 32GB
- QPS > 10 万（读写均衡）
- 需要横向扩展

**成本：** ¥150-250/月起

**优点：**
- ✅ 可扩展到 TB 级
- ✅ 百万级 QPS
- ✅ 自动分片

**缺点：**
- ❌ 成本高（5-6 倍）
- ❌ 运维复杂
- ❌ 有跨分片限制
- ❌ 对你的场景过度设计

---

## 🔧 应用代码兼容性

### 标准架构（无需修改）

**当前代码：**
```typescript
// src/config/redis.ts
const client = redis.createClient({
  host: config.redisHost,
  port: config.redisPort,
  password: config.redisPassword
});
```

**完全兼容：** ✅
- 无需修改代码
- 直接使用

### 集群架构（需要修改）

**需要修改代码：**
```typescript
// 需要使用集群客户端
const Redis = require('ioredis');

const cluster = new Redis.Cluster([
  {
    host: 'r-xxxxx.redis.rds.tencentyun.com',
    port: 6379
  }
], {
  redisOptions: {
    password: 'your_password'
  }
});
```

**限制：**
- ❌ 不支持某些命令（如 KEYS）
- ❌ 跨分片操作受限
- ❌ 需要测试兼容性

---

## 💡 最佳实践建议

### 初期部署（现在）

**推荐配置：**
```yaml
架构: 标准架构（主从版）
规格: 256MB
地域: 与应用服务器同地域
可用区: 与应用服务器同可用区
自动备份: 启用（每天凌晨 2 点）
```

**理由：**
- 满足当前需求
- 成本最低
- 运维简单
- 随时可升级

### 成长期（6-12 个月后）

**监控指标：**
- 内存使用率
- QPS
- 缓存命中率
- 响应时间

**升级路径：**
```
256MB 标准版
    ↓ （内存不足）
512MB 标准版
    ↓ （内存不足）
1GB 标准版
    ↓ （QPS 不足，读多写少）
1GB 主从版 + 读写分离（1 主 2-3 从）
    ↓ （数据量 > 32GB）
集群架构
```

### 成熟期（1-2 年后）

**评估是否需要集群：**

**需要集群的条件（同时满足）：**
1. ✅ 数据量 > 32GB
2. ✅ QPS > 10 万
3. ✅ 预算充足
4. ✅ 有专业运维团队

**否则：**
- 继续使用标准架构
- 通过应用层优化性能
- 考虑数据分层存储

---

## 📊 决策流程图

```
开始
  ↓
数据量 > 32GB？
  ├─ 是 → 考虑集群架构
  └─ 否 ↓
QPS > 10 万？
  ├─ 是 → 读写比例？
  │       ├─ 读多 → 标准架构 + 读写分离
  │       └─ 均衡 → 考虑集群架构
  └─ 否 ↓
预算充足？
  ├─ 是 → 标准架构（主从版）✅
  └─ 否 → 标准架构（单机版）
```

---

## ✅ 最终推荐

### 你的最佳选择：标准架构（主从版）

**配置建议：**
```yaml
架构: 标准架构（主从版）
规格: 256MB（初期）→ 512MB（成长期）
版本: Redis 7.0
主从: 1 主 1 从
自动切换: 启用
自动备份: 启用
淘汰策略: allkeys-lru
```

**理由总结：**
1. ✅ 满足性能需求（8-10 万 QPS vs 你的 1-10k QPS）
2. ✅ 满足容量需求（64GB vs 你的 < 1GB）
3. ✅ 高可用（99.9%，自动主从切换）
4. ✅ 成本低（¥30-50/月 vs 集群 ¥150+/月）
5. ✅ 运维简单（无需学习集群管理）
6. ✅ 代码无需修改（完全兼容）
7. ✅ 随时可升级（平滑升级路径）

**预期效果：**
- 缓存命中率：> 90%
- 响应时间：< 5ms
- 可用性：99.9%
- 成本：< ¥100/月

---

## 📚 相关文档

- [Redis 容量规划指南](./REDIS_CAPACITY_PLANNING.md)
- [Portainer 部署指南](./PORTAINER_DEPLOYMENT_GUIDE.md)
- [部署快速参考](./DEPLOYMENT_QUICK_REFERENCE.md)

---

**更新时间**: 2026-01-25
**建议复审**: 6 个月后根据实际使用情况调整
